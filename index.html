<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>alexhatchl — pixel rain</title>
  <style>
    html,body { margin:0; height:100%; background:#fff; }
    .stage { position:fixed; inset:0; width:100%; height:100%; display:block;
             image-rendering:pixelated; image-rendering:crisp-edges; }
    .overlay { position:fixed; inset:0; display:grid; place-items:center; z-index:3; color:#000; }
    h1 { margin:0; font-size:4rem; letter-spacing:.06em; }
    #load { position:fixed; left:16px; bottom:16px; color:#666; z-index:4; font:14px/1.2 system-ui, sans-serif; }
    @media (max-width:720px){ h1{ font-size:2.6rem; } }
  </style>
</head>
<body>
  <canvas id="px-bg" class="stage"></canvas>
  <canvas id="px-rain" class="stage" style="z-index:2;"></canvas>
  <div class="overlay"><h1>alexhatchl</h1></div>
  <div id="load">lädt…</div>

  <script>
  (function(){
    // canvases
    const bg = document.getElementById('px-bg');
    const rg = document.getElementById('px-rain');
    const bgx = bg.getContext('2d', {alpha:false});
    const rgx = rg.getContext('2d', {alpha:true});
    bgx.imageSmoothingEnabled = false;
    rgx.imageSmoothingEnabled = false;

    // helpers
    function fit(){
      const W = innerWidth, H = innerHeight;
      if (bg.width!==W) bg.width=W; if (bg.height!==H) bg.height=H;
      if (rg.width!==W) rg.width=W; if (rg.height!==H) rg.height=H;
      bgx.fillStyle = '#fff'; bgx.fillRect(0,0,W,H);
      if (img.complete) render();
    }
    addEventListener('resize', fit, {passive:true});
    fit();

    // ---------- Bild laden ----------
    const SOURCE = 'images/window-city.jpg?v=' + Date.now(); // <- liegt unter /cv/images/window-city.jpg
    const img = new Image();
    const loader = document.getElementById('load');
    img.crossOrigin = 'anonymous';
    img.onload  = ()=>{ loader.style.display='none'; render(); };
    img.onerror = ()=>{ loader.textContent = 'Bild nicht gefunden: ' + SOURCE; };
    img.src = SOURCE;

    // ---------- Pixelizer ----------
    const clamp=(v,mi,ma)=>v<mi?mi:v>ma?ma:v;
    const PIX_W = 320;     // Pixel-„Breite“
    let levels  = 4;       // 4 Graustufen (Taste B toggelt 4↔2)
    let showPix = true;    // P toggelt Original↔Pixel
    const GAMMA = 0.9, PUNCH = 1.25;

    function grayscale(id){
      const d=id.data, g=new Uint8ClampedArray(d.length/4);
      for (let i=0,j=0;i<d.length;i+=4,++j)
        g[j]=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;
      return g;
    }
    function percentiles(g, ps){
      const hist=new Uint32Array(256); for(const v of g) hist[v]++;
      const total=g.length; let c=0; const cum=new Uint32Array(256);
      for(let i=0;i<256;i++){ c+=hist[i]; cum[i]=c; }
      return ps.map(p=>{ const tgt=Math.max(0,Math.min(total-1,Math.round(p*total)));
        let i=0; while(i<256 && cum[i]<tgt) i++; return i; });
    }
    function histStretch(g, pLo=0.02, pHi=0.98){
      const [lo,hi]=percentiles(g,[pLo,pHi]); const rng=Math.max(1,hi-lo);
      for(let i=0;i<g.length;i++){ let v=((g[i]-lo)*255/rng); g[i]=clamp(v,0,255); }
      return g;
    }
    function gammaPunch(g){
      for(let i=0;i<g.length;i++){ let v=g[i]/255; v=Math.pow(v,GAMMA); v=(v-0.5)*PUNCH+0.5; g[i]=clamp(Math.round(v*255),0,255); }
      return g;
    }
    function quantize(g, n){
      if(n===2){ const [med]=percentiles(g,[0.5]); const out=new Uint8ClampedArray(g.length);
        for(let i=0;i<g.length;i++) out[i]=(g[i]<med?0:255); return out; }
      const [p25,p50,p75]=percentiles(g,[0.25,0.5,0.75]); const out=new Uint8ClampedArray(g.length);
      for(let i=0;i<g.length;i++){ const v=g[i]; out[i]=(v<p25)?0:(v<p50)?85:(v<p75)?170:255; } return out;
    }
    function drawCover(ctx, src){
      const W=ctx.canvas.width,H=ctx.canvas.height;
      let sw,sh; if(src instanceof HTMLImageElement){ sw=src.naturalWidth; sh=src.naturalHeight; } else { sw=src.width; sh=src.height; }
      const sR=sw/sh; let dw=W, dh=Math.round(W/sR); if(dh<H){ dh=H; dw=Math.round(H*sR); }
      const dx=Math.round((W-dw)/2), dy=Math.round((H-dh)/2);
      ctx.imageSmoothingEnabled=false; ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
      ctx.drawImage(src,0,0,sw,sh,dx,dy,dw,dh);
    }
    function drawPixelized(){
      const ratio=img.height/img.width, w=PIX_W, h=Math.round(w*ratio);
      const small=document.createElement('canvas'); small.width=w; small.height=h;
      const sx=small.getContext('2d'); sx.imageSmoothingEnabled=false; sx.drawImage(img,0,0,w,h);
      const id=sx.getImageData(0,0,w,h);
      let g=grayscale(id); g=histStretch(g,0.02,0.98); g=gammaPunch(g);
      const q=quantize(g, levels);
      const d=id.data; for(let i=0,j=0;i<d.length;i+=4,++j){ const v=q[j]; d[i]=d[i+1]=d[i+2]=v; d[i+3]=255; }
      sx.putImageData(id,0,0); drawCover(bgx, small);
    }
    function drawOriginal(){ drawCover(bgx, img); }
    function render(){ showPix ? drawPixelized() : drawOriginal(); }

    // ---------- Regen ----------
    function rebuildRain(){
      COLS=Math.max(36,Math.min(120,Math.round(bg.width/18)));
      streaks=Array.from({length:COLS},(_,i)=>({
        xNorm:(i+Math.random()*0.5)/COLS, y:Math.random(),
        v:0.18+Math.random()*0.32, len:0.06+Math.random()*0.22, wob:Math.random()*0.5+0.15
      }));
    }
    let COLS=64, streaks=[]; rebuildRain();

    let last=performance.now();
    function loop(now){
      const dt=Math.min(0.05,(now-last)/1000); last=now;
      const W=rg.width,H=rg.height; rgx.clearRect(0,0,W,H); rgx.fillStyle='#000';
      for(const s of streaks){
        const x=Math.round(s.xNorm*W + Math.sin(now*0.0009+s.xNorm*10)*s.wob*6);
        const y=s.y*H, L=Math.round(s.len*H);
        for(let k=0;k<L;k+=2){
          const yy=(y+k)|0; if(yy>=0&&yy<H){
            rgx.fillRect(x,yy,1,1);
            if((k%6)===0){ if(x+1<W)rgx.fillRect(x+1,yy,1,1); if(x-1>=0)rgx.fillRect(x-1,yy,1,1); }
          }
        }
        rgx.fillRect(x-1,(y+L+1)|0,3,2);
        s.y+=s.v*dt;
        if(s.y*H>H+12){ s.y=-Math.random()*0.2; s.len=0.06+Math.random()*0.22; s.v=0.18+Math.random()*0.32; }
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // Shortcuts
    addEventListener('keydown', (e)=>{
      const k=e.key.toLowerCase();
      if(k==='p'){ showPix=!showPix; render(); }
      if(k==='b'){ levels=(levels===4?2:4); render(); }
    });
  })();
  </script>
</body>
</html>
