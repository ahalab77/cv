<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>alexhatchl â€” kinetic grid</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html,body{height:100%;margin:0;background:#f4f4f4}
    canvas#stage{
      position:fixed; inset:0; width:100vw; height:100vh; z-index:2;
      image-rendering: pixelated; image-rendering: crisp-edges; display:block;
    }
    #err {
      position:fixed; left:8px; top:8px; z-index:99;
      background:#111; color:#fff; font:12px/1.3 ui-monospace,monospace;
      padding:6px 8px; border-radius:6px; display:none; max-width:60ch;
      white-space:pre-wrap
    }
  </style>
</head>
<body>

<canvas id="stage"></canvas>
<div id="err"></div>

<script>
(function(){
  var view = document.getElementById('stage');
  var vtx  = view.getContext('2d', {alpha:false});
  vtx.imageSmoothingEnabled = false;

  var buf = document.createElement('canvas');
  var btx = buf.getContext('2d', {alpha:false});
  btx.imageSmoothingEnabled = false;

  var PIX = 4, paused = false;

  function showErr(msg){
    var box = document.getElementById('err');
    box.style.display = 'block';
    box.textContent = msg;
  }

  function resize(){
    try{
      view.width  = Math.max(2, Math.floor(window.innerWidth));
      view.height = Math.max(2, Math.floor(window.innerHeight));
      var d = Math.min(view.width, view.height);
      PIX = d < 800 ? 3 : 4;
      buf.width  = Math.ceil(view.width  / PIX);
      buf.height = Math.ceil(view.height / PIX);

      // sofort sichtbarer Start (Papier + roter Balken)
      btx.fillStyle = '#F6F6F6'; btx.fillRect(0,0,buf.width,buf.height);
      btx.fillStyle = '#ff3b30'; btx.fillRect(4,4,Math.min(60,buf.width-8),10);
      vtx.clearRect(0,0,view.width,view.height);
      vtx.drawImage(buf,0,0,buf.width,buf.height,0,0,view.width,view.height);
    }catch(e){ showErr('resize() error: '+e.message); }
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ---- Farben
  var COLORS = { white:'#FFFFFF', red:'#E6432E', yellow:'#F4D21F', blue:'#1A3D9A', black:'#111111' };
  var PALETTE = [COLORS.white, COLORS.red, COLORS.yellow, COLORS.blue];
  function pickColor(){
    var r=Math.random();
    return (r<0.64)?COLORS.white : (r<0.80)?COLORS.red : (r<0.92)?COLORS.yellow : COLORS.blue;
  }
  function otherColor(base){
    var c = PALETTE.filter(function(x){return x!==base;});
    return c[(Math.random()*c.length)|0];
  }

  // ---- Layout
  var vLines,hLines,vCur,vTarget,hCur,hTarget,cells;

  function seedLayout(){
    var nV = 3 + (Math.random()*3|0);
    var nH = 3 + (Math.random()*3|0);
    function randPos(n){
      var s={}; var arr=[];
      while(arr.length<n){
        var x = Math.round((0.12+Math.random()*0.76)*1000)/1000;
        if(!s[x]){ s[x]=1; arr.push(x); }
      }
      arr.sort(function(a,b){return a-b;});
      return arr;
    }
    vLines=[0].concat(randPos(nV)).concat([1]);
    hLines=[0].concat(randPos(nH)).concat([1]);
    vCur=vLines.slice(); vTarget=vLines.slice();
    hCur=hLines.slice(); hTarget=hLines.slice();

    cells=[];
    for(var j=0;j<hLines.length-1;j++){
      var row=[];
      for(var i=0;i<vLines.length-1;i++) row.push(pickColor());
      cells.push(row);
    }

    bindTextRow();
  }

  // ---- dynamische Buchstaben-Gruppen
  var WORD='alexhatchl';
  var textRowIndex=0, groups=[];

  function bindTextRow(){
    var rows = hLines.length-1;
    textRowIndex = Math.max(0, Math.min(rows-1, (rows/2)|0));
    groups = WORD.split('');
    fitGroupsToCols();
  }
  function fitGroupsToCols(){
    var cols = vLines.length-1;
    while(groups.length>cols){
      var i = 1 + (Math.random()*(groups.length-1)|0);
      groups[i-1]+=groups[i]; groups.splice(i,1);
    }
    while(groups.length<cols){
      var idx=-1; for(var k=0;k<groups.length;k++){ if(groups[k].length>1){ idx=k; break; } }
      if(idx===-1){ groups.push(''); break; }
      var g=groups[idx], cut=1+(Math.random()*(g.length-1)|0);
      groups.splice(idx,1,g.slice(0,cut),g.slice(cut));
    }
  }
  function mutateGroups(){
    var cols=vLines.length-1;
    if(groups.length<=1 || Math.random()<0.5){
      var idxs=[]; for(var i=0;i<groups.length;i++) if(groups[i].length>1) idxs.push(i);
      if(idxs.length){
        var ii = idxs[(Math.random()*idxs.length)|0];
        var g=groups[ii], cut=1+(Math.random()*(g.length-1)|0);
        groups.splice(ii,1,g.slice(0,cut),g.slice(cut));
      }
    }else if(groups.length>=2){
      var j = 1 + (Math.random()*(groups.length-1)|0);
      groups[j-1]+=groups[j]; groups.splice(j,1);
    }
    fitGroupsToCols();
  }

  // ---- Mechanik
  var MIN_GAP=.08, STEP=.04, COUPLE=.55, EASE=.14;
  var nextBeatA=0, nextBeatB=0;

  function clamp(v,a,b){return v<a?a:(v>b?b:v);}
  function nudge(target,index,dir){
    var i=index, left=i-1, right=i+1;
    var step=dir*STEP;
    var minX=target[left]+MIN_GAP, maxX=target[right]-MIN_GAP;
    target[i]=clamp(target[i]+step,minX,maxX);
    if(left>0){
      var lmin=target[left-1]+MIN_GAP, lmax=target[i]-MIN_GAP;
      target[left]=clamp(target[left]+step*COUPLE,lmin,lmax);
    }
    if(right<target.length-1){
      var rmin=target[i]+MIN_GAP, rmax=target[right+1]-MIN_GAP;
      target[right]=clamp(target[right]+step*COUPLE,rmin,rmax);
    }
  }
  function recolor(){
    for(var j=0;j<cells.length;j++)
      for(var i=0;i<cells[j].length;i++)
        if(Math.random()<.28) cells[j][i]=pickColor();
  }
  function beat(){
    if(Math.random()<.5){
      if(vTarget.length>2) nudge(vTarget, 1+(Math.random()*(vTarget.length-2)|0), Math.random()<.5?-1:1);
    }else{
      if(hTarget.length>2) nudge(hTarget, 1+(Math.random()*(hTarget.length-2)|0), Math.random()<.5?-1:1);
    }
    if(Math.random()<.18) recolor();
    if(Math.random()<.9) mutateGroups();
  }

  function lerpTowards(cur,tgt,k){
    for(var i=0;i<cur.length;i++) cur[i]+= (tgt[i]-cur[i])*k;
  }

  function draw(){
    var W=buf.width, H=buf.height;
    btx.fillStyle='#F6F6F6'; btx.fillRect(0,0,W,H);

    for(var j=0;j<hCur.length-1;j++){
      var y0=Math.round(hCur[j]*H), y1=Math.round(hCur[j+1]*H);
      for(var i=0;i<vCur.length-1;i++){
        var x0=Math.round(vCur[i]*W), x1=Math.round(vCur[i+1]*W);
        btx.fillStyle=cells[j][i];
        btx.fillRect(x0,y0,x1-x0,y1-y0);
      }
    }

    // Textzeile
    var cols=vCur.length-1;
    if(groups.length!==cols) fitGroupsToCols();
    var ry0=Math.round(hCur[textRowIndex]*H), ry1=Math.round(hCur[textRowIndex+1]*H);
    var rcy=((ry0+ry1)/2)|0;
    var px=Math.max(6, Math.round(Math.min(W,H)*0.012)); // ~8px
    btx.save();
    btx.imageSmoothingEnabled=false;
    btx.font=px+'px "Press Start 2P", ui-monospace, monospace';
    btx.textAlign='center'; btx.textBaseline='middle';
    for(i=0;i<cols;i++){
      var g=groups[i]||''; if(!g) continue;
      var x0i=Math.round(vCur[i]*W), x1i=Math.round(vCur[i+1]*W);
      var cx=((x0i+x1i)/2)|0;
      btx.fillStyle=otherColor(cells[textRowIndex][i]);
      btx.fillText(g,cx,rcy);
    }
    btx.restore();

    // Linien
    var L=Math.max(2, Math.round(Math.min(W,H)*0.008));
    btx.fillStyle=COLORS.black;
    for(i=0;i<vCur.length;i++){ var x=Math.round(vCur[i]*W)-(L>>1); btx.fillRect(x,0,L,H); }
    for(j=0;j<hCur.length;j++){ var y=Math.round(hCur[j]*H)-(L>>1); btx.fillRect(0,y,W,L); }

    vtx.imageSmoothingEnabled=false;
    vtx.clearRect(0,0,view.width,view.height);
    vtx.drawImage(buf,0,0,W,H,0,0,view.width,view.height);
  }

  // --- Start (bewusst in dieser Reihenfolge)
  try{
    seedLayout();   // 1) Layout erzeugen
    draw();         // 2) sofort einmal zeichnen
  }catch(e){
    showErr('init error: '+e.message);
  }

  var t0 = performance.now();
  function tick(now){
    try{
      if(!paused){
        var t=(now-t0)/1000;
        lerpTowards(vCur,vTarget,.14);
        lerpTowards(hCur,hTarget,.14);
        if(t>=nextBeatA){ beat(); nextBeatA = t + (0.85 + (Math.random()*0.16 - 0.08)); }
        if(t>=nextBeatB){ beat(); nextBeatB = t + (1.38 + (Math.random()*0.22 - 0.11)); }
        draw();
      }
    }catch(e){
      showErr('loop error: '+e.message);
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Shortcuts
  window.addEventListener('keydown', function(e){
    var k=e.key.toLowerCase();
    if(k===' ') paused=!paused;
    if(k==='r'){ seedLayout(); draw(); }
    if(k==='c'){ recolor(); }
    if(k==='b'){
      PIX = (PIX===4)?6:(PIX===6?3:4);
      buf.width=Math.ceil(view.width/PIX); buf.height=Math.ceil(view.height/PIX);
      draw();
    }
  });
})();
</script>

</body>
</html>
