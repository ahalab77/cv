<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pixelizer (B/W · Dither)</title>
<style>
  :root { --bg:#0b0b0b; --fg:#eaeaea; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-weight:600;margin:0 0 12px}
  .panel{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
  label{opacity:.85}
  input[type="range"]{width:220px}
  .canvas-wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  canvas{width:100%;background:#111;image-rendering: pixelated;image-rendering: crisp-edges;border:1px solid #222}
  .btn{background:#1f1f1f;color:#fff;border:1px solid #333;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn:hover{background:#262626}
  .note{opacity:.7}
</style>
</head>
<body>
<div class="wrap">
  <h1>Pixelizer — Schwarz/Weiß · Dithering</h1>
  <div class="panel">
    <input type="file" id="file" accept="image/*" class="btn">
    <label>Breite (Pixelraster)
      <input type="range" id="pw" min="80" max="320" value="192">
      <span id="pwv">192</span>
    </label>
    <label>Palette
      <select id="pal">
        <option value="bw">Schwarz/Weiß</option>
        <option value="gray4">4 Graustufen</option>
      </select>
    </label>
    <label>Dithering
      <select id="dith">
        <option value="fs">Floyd–Steinberg</option>
        <option value="ordered">Geordnet</option>
        <option value="none">Keins</option>
      </select>
    </label>
    <label>Kontrast
      <input type="range" id="ctr" min="0.6" max="1.6" step="0.05" value="1.1">
      <span id="ctrv">1.10</span>
    </label>
    <button id="save" class="btn">PNG speichern</button>
  </div>

  <div class="canvas-wrap">
    <div>
      <div class="note">Original</div>
      <canvas id="src"></canvas>
    </div>
    <div>
      <div class="note">Pixel-Art</div>
      <canvas id="dst"></canvas>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const srcC = $("#src"), dstC = $("#dst");
const srcX = srcC.getContext("2d"), dstX = dstC.getContext("2d");
let img = new Image(); img.crossOrigin = "anonymous";

const palets = {
  bw: [[0,0,0],[255,255,255]],
  gray4: [[0,0,0],[85,85,85],[170,170,170],[255,255,255]],
};
function nearest(rgb, pal){
  let best=0, bd=1e9;
  for(let i=0;i<pal.length;i++){
    const p=pal[i]; const dx=p[0]-rgb[0], dy=p[1]-rgb[1], dz=p[2]-rgb[2];
    const d = dx*dx+dy*dy+dz*dz;
    if(d<bd){bd=d; best=i;}
  }
  return pal[best];
}
function toImageData(img){
  const w = img.width, h = img.height;
  srcC.width = w; srcC.height = h; srcX.drawImage(img,0,0);
  return srcX.getImageData(0,0,w,h);
}
function scaleToWidth(w){
  const ratio = img.height/img.width;
  const h = Math.round(w*ratio);
  return {w,h};
}
function applyContrast(v, c){
  return Math.max(0, Math.min(255, (v-128)*c + 128));
}
function floydSteinberg(data, w, h, pal, ctr){
  const arr = new Float32Array(data);
  const out = new Uint8ClampedArray(arr.length);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const i = (y*w + x)*4;
      let r=applyContrast(arr[i],ctr), g=applyContrast(arr[i+1],ctr), b=applyContrast(arr[i+2],ctr);
      const [nr,ng,nb] = nearest([r,g,b], pal);
      out[i]=nr; out[i+1]=ng; out[i+2]=nb; out[i+3]=255;
      const er=r-nr, eg=g-ng, eb=b-nb;
      function add(ix,iy, fr){
        if(ix<0||ix>=w||iy<0||iy>=h) return;
        const j=(iy*w+ix)*4;
        arr[j]+=er*fr; arr[j+1]+=eg*fr; arr[j+2]+=eb*fr;
      }
      add(x+1,y,7/16); add(x-1,y+1,3/16); add(x,y+1,5/16); add(x+1,y+1,1/16);
    }
  }
  return out;
}
function orderedDither(data, w, h, pal, ctr){
  const bayer8 = [
    0,48,12,60, 3,51,15,63,
    32,16,44,28,35,19,47,31,
    8,56, 4,52,11,59, 7,55,
    40,24,36,20,43,27,39,23,
    2,50,14,62, 1,49,13,61,
    34,18,46,30,33,17,45,29,
    10,58, 6,54, 9,57, 5,53,
    42,26,38,22,41,25,37,21
  ].map(v=>v/64-0.5);
  const out = new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const i=(y*w+x)*4;
      let r=applyContrast(data[i],ctr), g=applyContrast(data[i+1],ctr), b=applyContrast(data[i+2],ctr);
      const t = bayer8[(y&7)*8+(x&7)]*32;
      r = Math.max(0,Math.min(255,r+t));
      g = Math.max(0,Math.min(255,g+t));
      b = Math.max(0,Math.min(255,b+t));
      const [nr,ng,nb] = nearest([r,g,b], pal);
      out[i]=nr; out[i+1]=ng; out[i+2]=nb; out[i+3]=255;
    }
  }
  return out;
}
function render(){
  if(!img.width) return;
  const pixW = +$("#pw").value;
  $("#pwv").textContent = pixW;
  const pal = palets[$("#pal").value];
  const dith = $("#dith").value;
  const ctr = +$("#ctr").value; $("#ctrv").textContent = ctr.toFixed(2);

  // runterskalieren (Nearest)
  const {w:hW,h:hH} = scaleToWidth(pixW);
  const tmp = document.createElement("canvas");
  tmp.width = pixW; tmp.height = hH;
  const tctx = tmp.getContext("2d");
  tctx.imageSmoothingEnabled = false;
  tctx.drawImage(img, 0,0, pixW, hH);

  const srcData = tctx.getImageData(0,0,pixW,hH);
  let outData;
  if(dith==="ordered") outData = orderedDither(srcData.data, pixW, hH, pal, ctr);
  else if(dith==="none") outData = (function(){
    const arr = srcData.data, out = new Uint8ClampedArray(arr.length);
    for(let i=0;i<arr.length;i+=4){
      const [nr,ng,nb] = nearest([applyContrast(arr[i],ctr), applyContrast(arr[i+1],ctr), applyContrast(arr[i+2],ctr)], pal);
      out[i]=nr; out[i+1]=ng; out[i+2]=nb; out[i+3]=255;
    }
    return out;
  })();
  else outData = floydSteinberg(srcData.data, pixW, hH, pal, ctr);

  // groß skalieren (sichtbare Pixel)
  dstC.width = pixW*6; dstC.height = hH*6;
  const small = new ImageData(outData, pixW, hH);
  const stage = document.createElement("canvas");
  stage.width = pixW; stage.height = hH;
  stage.getContext("2d").putImageData(small,0,0);
  dstX.imageSmoothingEnabled = false;
  dstX.clearRect(0,0, dstC.width, dstC.height);
  dstX.drawImage(stage, 0,0, dstC.width, dstC.height);

  // Original daneben
  srcC.width = dstC.width; srcC.height = dstC.height;
  srcX.imageSmoothingEnabled = false;
  srcX.drawImage(img, 0,0, srcC.width, srcC.height);
}

$("#file").addEventListener("change", e=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  img = new Image(); img.onload = ()=>{ URL.revokeObjectURL(url); render(); };
  img.src = url;
});
["pw","pal","dith","ctr"].forEach(id => $("#"+id).addEventListener("input", render));
$("#save").addEventListener("click", ()=>{
  const a = document.createElement("a");
  a.href = dstC.toDataURL("image/png");
  a.download = "pixel_art.png";
  a.click();
});
</script>
</body>
</html>
